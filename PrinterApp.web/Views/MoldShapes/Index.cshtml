@model IEnumerable<PrinterApp.Models.ViewModels.MoldShapeViewModel>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["MoldShapes"];
    var searchTerm = ViewData["CurrentFilter"]?.ToString() ?? "";
}

<div class="content-container">
    <div class="page-header">
        <h2>🔷 @Localizer["MoldShapeManagement"]</h2>
        <a asp-action="Create" class="btn-primary-custom">
            ➕ @Localizer["AddNew"]
        </a>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card-custom" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);">
            <div class="stat-icon-custom">📊</div>
            <div class="stat-info-custom">
                <div class="stat-value-custom">@Model.Count()</div>
                <div class="stat-label-custom">@Localizer["TotalRecords"]</div>
            </div>
        </div>

        <div class="stat-card-custom" style="background: linear-gradient(135deg, var(--success-color) 0%, #28a745 100%);">
            <div class="stat-icon-custom">✓</div>
            <div class="stat-info-custom">
                <div class="stat-value-custom">@Model.Count(s => s.IsActive)</div>
                <div class="stat-label-custom">@Localizer["ActiveRecords"]</div>
            </div>
        </div>

        <div class="stat-card-custom" style="background: linear-gradient(135deg, var(--info-color) 0%, #17a2b8 100%);">
            <div class="stat-icon-custom">🔷</div>
            <div class="stat-info-custom">
                <div class="stat-value-custom">@Model.Sum(s => s.MoldsCount)</div>
                <div class="stat-label-custom">@Localizer["TotalRecords"] @Localizer["Molds"]</div>
            </div>
        </div>
    </div>

    <!-- Search Box -->
    <div class="card-custom" style="margin-bottom: 20px;">
        <div class="card-body-custom">
            <form asp-action="Index" method="get" style="display: flex; gap: 10px;">
                <input type="text"
                       name="searchTerm"
                       value="@searchTerm"
                       class="form-control-custom"
                       placeholder="@Localizer["SearchPlaceholder"]"
                       style="flex: 1;" />
                <button type="submit" class="btn-primary-custom" style="min-width: 120px;">
                    🔍 @Localizer["Search"]
                </button>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <a asp-action="Index" class="btn-secondary-custom" style="min-width: 120px;">
                        🔄 @Localizer["Reset"]
                    </a>
                }
            </form>
        </div>
    </div>

    <!-- Mold Shapes Table -->
    <div class="card-custom">
        <div class="card-header-custom">
            <h2>🔷 @Localizer["MoldShapes"]</h2>
        </div>
        <div class="card-body-custom">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table-custom">
                        <thead>
                            <tr>
                                <th style="width: 80px; text-align: center;">@Localizer["ShapeImage"]</th>
                                <th>@Localizer["MoldShapeName"]</th>
                                <th>@Localizer["Description"]</th>
                                <th style="width: 120px; text-align: center;">@Localizer["MoldsCount"]</th>
                                <th style="width: 120px; text-align: center;">@Localizer["Status"]</th>
                                <th style="width: 150px; text-align: center;">@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var shape in Model)
                            {
                                <tr>
                                    <td style="text-align: center;">
                                        @if (!string.IsNullOrEmpty(shape.ShapeImagePath))
                                        {
                                            <img src="@shape.ShapeImagePath"
                                                 alt="@shape.ShapeName"
                                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--border-radius-sm); border: 2px solid var(--border-color); cursor: pointer;"
                                                 onclick="showImageModal('@shape.ShapeImagePath', '@shape.ShapeName')" />
                                        }
                                        else
                                        {
                                            <div style="width: 60px; height: 60px; background: var(--light-gray); border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; border: 2px solid var(--border-color);">
                                                <span style="font-size: 24px;">🔷</span>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                                            @shape.ShapeName
                                        </div>
                                        <small style="color: var(--medium-gray);">
                                            @Localizer["CreatedDate"]: @shape.CreatedDate.ToString("dd/MM/yyyy")
                                        </small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(shape.Description))
                                        {
                                            <span>@shape.Description</span>
                                        }
                                        else
                                        {
                                            <span style="color: var(--medium-gray); font-style: italic;">@Localizer["NoDataAvailable"]</span>
                                        }
                                    </td>
                                    <td style="text-align: center;">
                                        <span class="badge-custom" style="background: var(--info-color); color: white; font-size: 16px; padding: 8px 16px;">
                                            @shape.MoldsCount
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        @if (shape.IsActive)
                                        {
                                            <span class="badge-custom badge-success-custom">✓ @Localizer["Active"]</span>
                                        }
                                        else
                                        {
                                            <span class="badge-custom badge-danger-custom">✗ @Localizer["Inactive"]</span>
                                        }
                                    </td>
                                    <td style="text-align: center;">
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <a asp-action="Edit" asp-route-id="@shape.Id" class="btn-action-custom btn-action-edit-custom" title="@Localizer["Edit"]">
                                                ✏️
                                            </a>

                                            <form asp-action="ToggleStatus" asp-route-id="@shape.Id" method="post" style="display: inline;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit"
                                                        class="btn-action-custom @(shape.IsActive ? "btn-action-warning-custom" : "btn-action-success-custom")"
                                                        title="@(shape.IsActive? Localizer["Deactivate"] : Localizer["Activate"])">
                                                    @(shape.IsActive ? "⏸️" : "▶️")
                                                </button>
                                            </form>

                                            @if (shape.MoldsCount == 0)
                                            {
                                                <form asp-action="Delete" asp-route-id="@shape.Id" method="post" style="display: inline;"
                                                      onsubmit="return confirm('@Localizer["DeleteConfirmation"]');">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn-action-custom btn-action-delete-custom" title="@Localizer["Delete"]">
                                                        🗑️
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <button type="button"
                                                        class="btn-action-custom"
                                                        style="background: var(--medium-gray); cursor: not-allowed; opacity: 0.5;"
                                                        title="Cannot delete - has @shape.MoldsCount associated mold(s)"
                                                        disabled>
                                                    🗑️
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 60px 20px; color: var(--medium-gray);">
                    <div style="font-size: 64px; margin-bottom: 20px;">🔷</div>
                    <h3 style="margin-bottom: 10px;">@Localizer["NoResultsFound"]</h3>
                    <p style="margin-bottom: 20px;">@Localizer["NoDataAvailable"]</p>
                    <a asp-action="Create" class="btn-primary-custom">
                        ➕ @Localizer["AddNew"]
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); overflow: auto;">
    <span onclick="closeImageModal()" style="position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;">&times;</span>
    <img id="modalImage" style="margin: auto; display: block; max-width: 90%; max-height: 90%; margin-top: 50px; border-radius: var(--border-radius);">
    <div id="modalCaption" style="margin: auto; display: block; width: 80%; max-width: 700px; text-align: center; color: #ccc; padding: 10px 0; height: 50px;"></div>
</div>

@section Scripts {
    <script>
        function showImageModal(imagePath, caption) {
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('modalImage').src = imagePath;
            document.getElementById('modalCaption').innerHTML = caption;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal when clicking outside the image
        document.getElementById('imageModal').onclick = function(event) {
            if (event.target == this) {
                closeImageModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
}
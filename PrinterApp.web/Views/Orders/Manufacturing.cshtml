@model PrinterApp.Models.ViewModels.OrderStage3ViewModel

@{
    ViewData["Title"] = "التصنيع";
}

<div class="content-container">
    <div class="page-header">
        <h2>⚙️ تصنيع الطلب - @Model.OrderNumber</h2>
        <a asp-action="ManufacturingList" class="btn-secondary-custom">← عودة</a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert-custom alert-success-custom">✓ @TempData["Success"]</div>
    }

    <div class="card-custom">
        <div style="padding: 30px;">
            <!-- Order Summary -->
            <div style="background: var(--input-bg); padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px;">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">ملخص الطلب</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>العميل:</strong> @Model.CustomerName</div>
                    <div><strong>المنتج:</strong> @Model.ProductName</div>
                    <div><strong>الكمية:</strong> @Model.Quantity</div>
                </div>
            </div>

            <!-- Manufacturing Checklist -->
            <div style="background: var(--input-bg); padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px;">
                <h4 style="color: var(--primary-color); margin-bottom: 20px;">✓ قائمة عناصر التصنيع</h4>
                @if (Model.ManufacturingItems.Any())
                {
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        @foreach (var item in Model.ManufacturingItems)
                        {
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--white); border: 2px solid @(item.IsCompleted ? "var(--success-color)" : "var(--border-color)"); border-radius: var(--border-radius);">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span style="font-size: 24px;">@(item.IsCompleted ? "✓" : "○")</span>
                                    <div>
                                        <div style="font-weight: bold; font-size: 16px;">@item.AdditionName</div>
                                        @if (item.IsCompleted && item.CompletedDate.HasValue)
                                        {
                                            <div style="font-size: 12px; color: var(--success-color);">
                                                مكتمل - @item.CompletedDate.Value.ToString("dd/MM/yyyy HH:mm")
                                            </div>
                                        }
                                    </div>
                                </div>
                                @if (!item.IsCompleted)
                                {
                                    <form asp-action="CompleteManufacturingItem" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="orderId" value="@Model.Id" />
                                        <input type="hidden" name="itemId" value="@item.Id" />
                                        <button type="submit" class="btn-success-custom btn-sm-custom">
                                            ✓ إكمال
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <span style="background: var(--success-color); color: var(--white); padding: 5px 15px; border-radius: var(--border-radius-sm); font-weight: bold;">
                                        مكتمل
                                    </span>
                                }
                            </div>
                        }
                    </div>

                    <!-- Progress Bar -->
                    <div style="margin-top: 20px;">
                    @{
                        var completed = Model.ManufacturingItems.Count(i => i.IsCompleted);
                        var total = Model.ManufacturingItems.Count;
                        var percentage = total > 0 ? (int)((double)completed / total * 100) : 0;
                    }
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>التقدم:</strong> @completed من @total</span>
                            <span><strong>@percentage%</strong></span>
                        </div>
                        <div style="width: 100%; height: 25px; background: var(--border-color); border-radius: var(--border-radius); overflow: hidden;">
                            <div style="width: @percentage%; height: 100%; background: var(--success-color); transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- Move to Printing -->
                    @if (completed == total)
                    {
                        <form asp-action="MoveToPrinting" asp-route-id="@Model.Id" method="post" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                            @Html.AntiForgeryToken()
                            <div style="text-align: center;">
                                <button type="submit" class="btn-success-custom" style="font-size: 16px; padding: 12px 30px;">
                                    ➡️ نقل إلى مرحلة الطباعة
                                </button>
                            </div>
                        </form>
                    }
                }
                else
                {
                    <p style="text-align: center; color: var(--medium-gray);">لا توجد عناصر تصنيع لهذا الطلب</p>
                }
            </div>
        </div>
    </div>
</div>
